<script>
    const BYZ_CLASSNAME = 'byzantine'

    nodeElements = {}
    const nodes = JSON.parse('{{ data.nodes_data | tojson }}').map(el => {
        // pre-get all dom nodes on mount, this won't change
        id = el.data.node_id
        nodeElements[id] = {
            node: document.getElementById(`node-${id}`),
            data: document.getElementById(`data-node-${id}`),
            byzBehaviorSpan: document.getElementById(`byz-behavior-${id}`)
        }
        return el.node
    })
    const defaultFetchInterval = 100
    const testName = document.getElementById('test-name')
    let interval, fetchInterval = defaultFetchInterval

    const strongify = s => `<b><u>${s}</u></b>`

    const renderByzantineNode = (id, behavior) => {
        nodeElements[id].node.classList.add(BYZ_CLASSNAME)
        nodeElements[id].byzBehaviorSpan.innerHTML = behavior
    }

    const renderNormalNode = (id) => {
        nodeElements[id].node.classList.remove(BYZ_CLASSNAME)
        nodeElements[id].byzBehaviorSpan.innerHTML = ''
    }

    const renderViewEstData = (id, data) => {
        let phases = 'Phases: ', views = 'Views: ', witnesses = 'Witnesses: '

        // build phases string
        data.phs.forEach((p,i) => {
            phases += i == id ? `${strongify(p)} ` : `${p} `
        })

        data.views.forEach((v,i) => {
            vp = `[${v.current},${v.next}]`
            views += i == id ? `${strongify(vp)} ` : `${vp} `
        })

        data.witnesses.forEach((w,i) => {
            w_ = w ? 'True' : 'False'
            witnesses += i == id ? `${strongify(w_)} `: `${w_} `
        })

        vChange = data.vChange ? 'True' : 'False'
        
        nodeElements[id].data.children[0].innerHTML = phases
        nodeElements[id].data.children[1].innerHTML = views
        nodeElements[id].data.children[2].innerHTML = `vChange: ${vChange}`
        nodeElements[id].data.children[3].innerHTML = witnesses
    }

    const renderRepData = (id, data) => {}
    const renderPriMonData = (id, data) => {}

    // fetches data for all nodes and updates the view
    const refreshNodes = () => {
        nodes.forEach(n => {
            fetch(`http://${n.ip}:400${n.id}/data`)
                .then(res => res.json())
                .then(res => {
                    res.byzantine
                        ? renderByzantineNode(res.node_id, res.byzantine_behavior)
                        : renderNormalNode(res.node_id)
                    renderViewEstData(res.node_id, res.VIEW_ESTABLISHMENT_MODULE)
                    renderRepData(res.node_id, res.REPLICATION_MODULE)
                    renderPriMonData(res.node_id, res.PRIMARY_MONITORING_MODULE)

                    testName.innerHTML = res.test_data.test_name || 'unknown test'

                    // back to full speed if speed was throttled
                    if (fetchInterval > defaultFetchInterval) {
                        fetchInterval = defaultFetchInterval
                        interval = setInterval(refreshNodes, fetchInterval)
                    }
                })
                .catch(err => {
                    console.error(err)
                    // new slower fetch interval when node is down
                    clearInterval(interval)
                    fetchInterval = defaultFetchInterval * 10
                    interval = setInterval(refreshNodes, fetchInterval)
                })
        })
    }

    // register listeners and handlers
    const onLoad = () => {
        interval = setInterval(refreshNodes, defaultFetchInterval)
        // document.getElementById("refreshButton").onclick = refreshNodes
    }
    window.onload = onLoad;
</script>